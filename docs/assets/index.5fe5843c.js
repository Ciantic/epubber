import{t as E,d as C,c as v,i as S,a as x,b as H,S as I,B as U,Z as B,e as D,T,r as z}from"./vendor.f9497a2c.js";const W=function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))f(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&f(d)}).observe(document,{childList:!0,subtree:!0});function c(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerpolicy&&(i.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?i.credentials="include":l.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function f(l){if(l.ep)return;l.ep=!0;const i=c(l);fetch(l.href,i)}};W();const j=E('<div><h1>Concats all the epub HTML files</h1><h2>Select epub file</h2><input type="file" name=""><h2>Or type fetchable URL</h2><p>This does not work at the moment, because of CSP</p><input value="" type="text" size="80" placeholder="URL"> <button type="button">Fetch</button><br></div>'),Z=E('<div><h1 class="book-title"></h1></div>'),_=E("<div></div>"),G=E('<section class="html-page"></section>');function p(n,u){return new URL(n,new URL(u,"https://example.com")).pathname}async function V(n){return await n.getData?.(new T)}async function P(n){return await n?.getData?.(new U)}const O=async n=>{const c=await new B(new D(n)).getEntries(),f=new Map(c.map(o=>["/"+o.filename,o])),l=c.filter(o=>o.filename.endsWith(".opf"));if(l.length!==1)throw new Error("OPF confusion");const i=l[0],d=await i.getData?.(new T),g=new DOMParser().parseFromString(d,"text/xml"),b=[...g.querySelectorAll("manifest item")],A=[...g.querySelectorAll("title")].map(o=>o.textContent||"");console.log("opf",d);const w=b.filter(o=>o.getAttribute("media-type")?.match(/html/)).map(o=>o.getAttribute("href")||"\u2705").map(o=>{const r=f.get(p(o,i.filename));if(r)return r;const t=f.get(p(o,"/OEBPS/"));if(t)return t;const s=f.get(p(o,"/OPS/"));if(s)return s;const e=f.get(p(o,"/"));if(e)return e}).filter(o=>o);if(w.length===0)throw console.error("OPF",d,"OPF Items:",b,"ZIP File entries:",[...f.keys()]),new Error("No HTML Files found from the ebook");return{documents:(await Promise.all(w.map(async o=>({content:await V(o),filename:o.filename})))).map(({content:o,filename:r})=>{let t=new DOMParser().parseFromString(o,"application/xhtml+xml");return t.querySelector("parsererror")&&(t=new DOMParser().parseFromString(o,"text/html")),t.querySelectorAll("[href]").forEach(e=>{e instanceof HTMLElement&&(e.dataset.href=p(e.getAttribute("href")||"",r),e.setAttribute("href","#"))}),t.querySelectorAll("[src]").forEach(e=>{e instanceof HTMLElement&&(e.dataset.src=p(e.getAttribute("src")||"",r),e.removeAttribute("src"))}),[...t.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")].forEach(e=>{if(e instanceof SVGImageElement){const a=e.getAttributeNS("http://www.w3.org/1999/xlink","href");e.dataset.href=p(a||"",r),e.removeAttributeNS("http://www.w3.org/1999/xlink","href")}}),t.querySelectorAll("style, hr, [aria-hidden]").forEach(e=>{e.remove()}),t.querySelectorAll("[style]").forEach(e=>{e.removeAttribute("style")}),t.querySelectorAll("[class]").forEach(e=>{e.removeAttribute("class")}),t.querySelectorAll("section,article,div").forEach(e=>{if(!e.id)e.replaceWith(...e.childNodes);else{const a=t.createElement("div");a.id=e.id,a.append(...e.childNodes),e.replaceWith(a)}}),t.querySelectorAll("h1 + h1").forEach(e=>{const a=e.previousElementSibling;a instanceof HTMLHeadingElement&&(a.append(t.createElement("br"),t.createTextNode(" ")),a.append(...e.childNodes),e.remove())}),t}),zipFileMap:f,titles:A}};async function q(n,u){if(n.hasAttribute("src"))return;const c=u.get(n.dataset.src||"");if(!c){console.error("Cant find file",n.dataset.src);return}const f=await P(c);n.onload=()=>{n.naturalWidth<300&&n.naturalHeight<300&&n.classList.add("small")},n.src=URL.createObjectURL(new File([f],c.filename))}async function k(n,u){if(n.hasAttributeNS("http://www.w3.org/1999/xlink","href"))return;const c=u.get(n.dataset.href||"");if(!c){console.error("Cant find file",n.dataset.href);return}const f=await P(c);n.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",URL.createObjectURL(new File([f],c.filename)))}const K=()=>{let n;const[u,c]=v(""),[f,l]=v([]),[i,d]=v([]),[h,g]=v(new Map),b=new IntersectionObserver(r=>{for(const t of r){const s=t.target;!t.isIntersecting||(s instanceof HTMLImageElement&&q(s,h()),s instanceof SVGElement&&[...s.getElementsByTagName("image")].forEach(e=>{k(e,h())}))}});function A(){document.querySelectorAll("img").forEach(r=>{q(r,h())}),[...document.getElementsByTagName("image")].forEach(r=>{k(r,h())})}function w(r){window.addEventListener("beforeprint",()=>{A()}),setTimeout(()=>{r.querySelectorAll("img").forEach(t=>{b.observe(t)}),r.querySelectorAll("svg").forEach(t=>b.observe(t))})}async function $(){if(!n)return;const r=n.files?.[0];if(r){const{documents:t,zipFileMap:s,titles:e}=await O(r);d(t),g(s),l(e)}}async function F(r){try{const t=await fetch(r,{mode:"no-cors",redirect:"follow"}),s=await t.blob();console.log("f",t,s);const{documents:e,zipFileMap:a,titles:m}=await O(s);d(e),g(a),l(m)}catch(t){t instanceof TypeError?c(t.name+": "+t.message):c("Unable to fetch")}}function o(){return(()=>{const r=j.cloneNode(!0),t=r.firstChild,s=t.nextSibling,e=s.nextSibling,a=e.nextSibling,m=a.nextSibling,y=m.nextSibling,R=y.nextSibling,L=R.nextSibling;L.nextSibling,e.$$input=$;const N=n;return typeof N=="function"?N(e):n=e,L.$$click=M=>{M.target.previousElementSibling instanceof HTMLInputElement&&F(M.target.previousElementSibling.value)},S(r,u,null),r})()}return(()=>{const r=_.cloneNode(!0);return S(r,x(I,{get when(){return i().length>0},fallback:()=>x(o,{}),get children(){const t=Z.cloneNode(!0),s=t.firstChild,e=w;return typeof e=="function"?e(t):w=t,S(s,()=>f().map((a,m)=>(()=>{const y=_.cloneNode(!0);return y.className=`line${m}`,S(y,a),y})())),S(t,()=>i().map(a=>(()=>{const m=G.cloneNode(!0);return H(()=>m.innerHTML=a.body.outerHTML),m})()),null),t}})),r})()};C(["input","click"]);z(()=>x(K,{}),document.getElementById("root"));
